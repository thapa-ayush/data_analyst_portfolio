{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}{{ project.title }} | Data Analyst Portfolio{% endblock %}
{% block meta_description %}{{ project.description }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/project_detail.css' %}">
{% endblock %}

{% block content %}
<div class="project-page-wrapper">
    <!-- Breadcrumb -->
    <div class="project-breadcrumb">
        <a href="{% url 'home' %}">Home</a>
        <span>/</span>
        <a href="{% url 'projects' %}">Projects</a>
        <span>/</span>
        <span>{{ project.title }}</span>
    </div>

    <!-- Project Hero Image -->
    <div class="project-hero">
        {% if project.image %}
        <img src="{{ project.image.url }}" alt="{{ project.title }}" loading="eager">
        {% else %}
        <div class="project-hero-fallback">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3.5 18.5l6-6 4 4L22 6.92 20.59 5.5l-7.09 8.58-4-4L2 18.5h1.5z" />
            </svg>
        </div>
        {% endif %}
    </div>
</div>

<!-- Project Header -->
<div class="project-header">
    {% if project.featured %}
    <span class="project-featured-badge">
        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
        </svg>Featured Project
    </span>
    {% endif %}
    <h1>{{ project.title }}</h1>

    <!-- Meta Information -->
    <div class="project-meta">
        {% if project.date_completed %}
        <div class="meta-item">
            <span class="meta-label">Completed</span>
            <span class="meta-value">{{ project.date_completed|date:"F Y" }}</span>
        </div>
        {% endif %}
        <div class="meta-item">
            <span class="meta-label">Status</span>
            <span class="meta-value">{{ project.get_status_display }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Category</span>
            <span class="meta-value">{{ project.get_category_display }}</span>
        </div>
    </div>
</div>

<!-- Project Links -->
<div class="project-links">
    {% if project.project_url %}
    <a href="{{ project.project_url }}" target="_blank" class="btn-project btn-primary-link">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
        </svg>View Live Project
    </a>
    {% endif %}
    {% if project.github_url %}
    <a href="{{ project.github_url }}" target="_blank" class="btn-project btn-secondary-link">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path
                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
        </svg>GitHub Repository
    </a>
    {% endif %}
    <a href="{% url 'projects' %}" class="btn-project btn-secondary-link">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
        </svg> Back to Projects
    </a>
</div>

<!-- Technologies -->
{% if project.technologies %}
<h2 class="section-title">Technologies Used</h2>
<div class="technologies-grid">
    {% for tech in project.get_technologies_list %}
    <div class="tech-card">
        <div class="tech-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
            </svg>
        </div>
        <div class="tech-name">{{ tech }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Key Achievements -->
{% if project.key_achievements %}
<h2 class="section-title">Key Achievements</h2>
<div class="achievements">
    {% for achievement in project.get_achievements_list %}
    <div class="achievement-item">
        <span class="achievement-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
            </svg>
        </span>
        <span>{{ achievement }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Description in PDF-like Document -->
<div class="document-container">
    <div class="document-header">
        <h3>
            <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
            </svg>Project Overview
        </h3>
    </div>
    <div class="document-scroll" id="projectContent">
        {{ project.detailed_description|safe }}
    </div>
</div>

<!-- Project Gallery -->
{% if project.images.all %}
<div class="project-gallery-section">
    <h2 class="section-title">
        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path
                d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z" />
        </svg>
        Project Gallery
    </h2>
    <div class="gallery-grid">
        {% for img in project.images.all %}
        <div class="gallery-item" onclick="openLightbox('{{ img.image.url }}', '{{ img.caption|escapejs }}')">
            <img src="{{ img.image.url }}" alt="{{ img.caption|default:project.title }}" loading="lazy">
            {% if img.caption %}
            <div class="gallery-caption">{{ img.caption }}</div>
            {% endif %}
            <div class="gallery-overlay">
                <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                    <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z" />
                </svg>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-img" class="lightbox-content" src="" alt="">
    <div id="lightbox-caption" class="lightbox-caption"></div>
</div>
{% endif %}

<!-- Share Section -->
<div class="share-section">
    <span class="share-label">Share this project:</span>
    <div class="share-buttons">
        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ project.title }}"
            target="_blank" class="share-btn" title="Share on Twitter">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                <path
                    d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
            </svg>
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" target="_blank"
            class="share-btn" title="Share on LinkedIn">in</a>
        <button class="share-btn" onclick="copyToClipboard('{{ request.build_absolute_uri }}')" title="Copy link">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path
                    d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" />
            </svg>
        </button>
    </div>
</div>

{% if related_projects %}
<div class="related-projects">
    <h2 class="section-title">Related Projects</h2>
    <div class="related-grid">
        {% for related in related_projects %}
        <a href="{% url 'project_detail' related.pk %}" class="related-card">
            <div class="related-image">
                {% if related.image %}
                <img src="{{ related.image.url }}" alt="{{ related.title }}">
                {% else %}
                <svg viewBox="0 0 24 24" fill="currentColor" class="related-image-placeholder">
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                </svg>
                {% endif %}
            </div>
            <div class="related-content">
                <h3 class="related-title">{{ related.title }}</h3>
                <p class="related-description">
                    {{ related.description|truncatewords:15 }}
                </p>
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Convert markdown to HTML while preserving existing HTML tags
    const contentDiv = document.getElementById('projectContent');
    if (contentDiv) {
        const html = contentDiv.innerHTML;
        // Check if content looks like markdown (has markdown syntax)
        if (html.includes('#') || html.includes('**') || html.includes('- ') || html.includes('* ')) {
            try {
                // Configure marked to allow HTML
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
                contentDiv.innerHTML = marked.parse(html);
            } catch (e) {
                // If marked fails, keep original content
                console.log('Markdown parsing skipped');
            }
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Link copied to clipboard!');
        }).catch(() => {
            alert('Failed to copy link');
        });
    }

    // Lightbox functions
    function openLightbox(src, caption) {
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        const captionEl = document.getElementById('lightbox-caption');

        lightbox.style.display = 'flex';
        img.src = src;
        captionEl.textContent = caption || '';
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Close lightbox on Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });
</script>
{% endblock %}